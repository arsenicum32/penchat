<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>UI for penchat</title>
    <!-- <link rel='stylesheet prefetch' href='http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css'> -->
    <link rel="stylesheet" href="public/UI.css">
    <script src="public/socket.io.js"></script>
    <script src="public/jquery.js"></script>
    <script src="public/jquery-ui.js"></script>
    <script src="public/fabric.js"></script>
    <script src="public/init.js"></script>
    <script src="public/canvas_lib.js"></script>
    <script src="public/normselect.js"></script>
    <script src="public/client/indexCan.js"></script>
    <script src="public/client/UI.js"></script>
    <script src="public/client/UI-events.js"></script>
    <script src="public/client/socket-events.js"></script>
    <script src="public/client/hack.js"></script>
  </head>
  <body>
<canvas id="c"></canvas>
<div id="top">
  <div id="menu"></div>
  <div class="left"><a href="#">file</a><a href="#">edit</a><a href="#">windows</a></div>
  <div class="right"><a id="counter">online: <span>0</span></a><a href="#">share</a><a id="sel" href="#">join</a></div>
</div>
<div id="menubox">
</div>
  <div id="draggable" class="interface hid">
    <p class='top'>main</p>
    <a href="#" class="item" onclick="UI('hand')" ><img src='/public/icons/svg/hand-pointer-1.svg' /></a>
    <a href="#" class="item" onclick="UI('cursor')" ><img src='/public/icons/svg/align-cursor.svg' /></a>
    <a href="#" class="item" onclick="UI('pen')" ><img src='/public/icons/svg/pen-tool.svg' /></a>
    <a href="#" class="item" onclick="UI('text')"><img src='/public/icons/svg/text-symbol.svg' /></a>
    <a href="#" class="item" onclick="UI('add')"><img src='/public/icons/svg/add-mark.svg' /></a>
    <a href="#" class="item" onclick="UI('disabled')" ><img src='/public/icons/svg/disabled.svg' /></a>
  </div>
<div id="help" class="native">
  <p>objtraker</p>
  <textarea></textarea>
</div>
<div id='logbox'></div>
        <script>

        (function(){
          if (navigator.userAgent.toLowerCase().indexOf('chrome') != -1) {
            		socket = io.connect('http://85.143.209.210:1280/test', { 'connect timeout': 5000 }); //{'transports': ['xhr-polling']});
            	} else {
            		socket = io.connect('http://85.143.209.210:1280/test', { 'connect timeout': 5000 });
                var ss = socket.socket;

            	}
              $('#logbox').hide();

              socket.on('connect_error', function(){
                $('#logbox').show(500);
                $('#logbox p').text('не удаётся подключиться');
              });

              socket.on('reconnect',function(){
                $('#logbox p').text('переподключение');
                location.reload();
              });

            	socket.on('connect', function () {
                $.get('http://api.penchat.ru/all', function(data){
                  canvas.loadFromJSON(data, canvas.renderAll.bind(canvas), function(o, object) {
                      //fabric.log(o, object);
                      var color = ['blue','red','yellow','hotpink'][Math.floor(Math.random()*4)];
                      object.set({
                              borderColor: color,
                              cornerColor: color,
                              cornerSize: 6,
                              transparentCorners: false
                      });
                    });
                });

                socket.on('modified', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = objGet(msg.id);
                    for(var n in msg){
                      obj[n]=msg[n];
                    }
                    canvas.renderAll();
                });

                socket.on('some', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = objGet(msg.id);
                    for(var n in msg){
                      obj[n]=msg[n];
                    }
                    canvas.renderAll();
                });

                //socket.emit('add', {});
                socket.on('add', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = addObject(msg);
                    canvas.renderAll();
                });

                socket.on('settext', function(msg){
                  var obj = objGet(msg.id);
                  if(obj){
                    obj.setText( msg.text );
                    canvas.renderAll();
                  }
                });

                socket.on('addtext', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = addText(msg);
                    canvas.renderAll();
                });

                socket.on('reload', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    location.reload();
                });

                socket.on('remove', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = removeObject(msg.id);
                    canvas.renderAll();
                });

                $('#logbox').hide(1500);
                //callFabricOn();
            		socket.on('people change', function (msg) {  // msg.render.hasOwnProperty('background')
                  $('#counter span').text(msg);
            		});
            	});
        })();


        </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>UI for penchat</title>
    <!-- <link rel='stylesheet prefetch' href='http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css'> -->
    <link rel="stylesheet" href="public/UI.css">
    <script src="public/socket.io.js"></script>
    <script src="public/jquery.js"></script>
    <script src="public/jquery-ui.js"></script>
    <script src="public/fabric.js"></script>
    <script src="public/init.js"></script>
    <script src="public/canvas_lib.js"></script>
    <!--  <script src="public/normselect.js"></script> -->
    <script src="public/client/indexCan.js"></script>
    <script src="public/client/UI.js"></script>
    <script src="public/client/UI-events.js"></script>
    <script src="public/client/socket-events.js"></script>
    <style type="text/css">
      .st1{stroke:blue;stroke-width:2;fill: hotpink;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}
      .st0{fill:none;stroke: deeppink;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}
      .st3{fill:yellow;stroke: aquamarine ;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}
    </style>
  </head>
  <body>
<canvas id="c"></canvas>
<div id="top">
  <div id="menu"></div>
  <div class="left"><a href="#">file</a><a href="#">edit</a><a href="#">windows</a></div>
  <div class="right"><a id="counter">online: <span>0</span></a><a href="#">share</a><a id="sel" href="#">join</a></div>
</div>
<div id="menubox">
</div>
  <div id="draggable" class="interface hid">
    <p class='top'>main</p>
    <svg version="1.1" id='Bhand' class='item interface' xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 30 30" style="enable-background:new 0 0 30 30;" xml:space="preserve">
    <path class="st0 interface" d="M10.6,27.9h12.9V25c0.1-1.1,0.3-2.7,0.8-4.6c1.6-6.7,4.9-10.3,3.5-12c-0.4-0.5-1.2-0.7-1.7-0.6
    	c-2,0.4-2.3,5.3-2.9,5.2c-0.5-0.1-0.4-2.5-0.4-3.7c0-1.6,0.2-3,0.4-3.9c0,0,0.2-1.9-2.3-1.9s-1.7,1.9-1.7,1.9S18.7,2.4,16,2.4
    	s-2.5,3.9-2.5,3.9L10.6,4c0,0-1.4-0.4-2.9,0.6c-1.5,1-1,3.3-1,3.3l3.5,8.3l-3.6-2.9c0,0-3-1.5-3.9,0c-0.5,0.8-0.8,1.5-0.9,2.3
    	c0,1.1,0.5,2,0.9,2.6c2.2,3.2,5.2,3.1,7,5.8C10.1,24.6,10.7,25.9,10.6,27.9z"/>
    </svg>
        <svg version="1.1" id='Badd' class='item interface' xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
        	 viewBox="0 0 30 30" style="enable-background:new 0 0 30 30;" xml:space="preserve">
        <path class="item interface st1" d="M7.8,17.7H2.3V1.5h16.2v5H22c0,0,2.7-0.2,2.7,3.1s0,5.9,0,5.9s3.5,0.5,3.5,6s-2.7,7-6.7,7s-5.7-2.7-6.2-5.7
        	S15,15.2,21,14.9"/>
        </svg>
        <svg version="1.1" id='Btype' class='item interface' xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
        	 viewBox="0 0 30 30" style="enable-background:new 0 0 30 30;" xml:space="preserve">
        <path class="item interface st3" d="M3,11V4h24v6.6L16.8,6.8l2,18.2h3.3c0,0,1.6,0.2,1.7,1.2c0,1-0.2,1.8-1.5,1.8C21,28,11,28,11,28"/>
        </svg>
    <a href="#" class="item">bye</a>
    <a href="#" class="item">hi</a>
    <a href="#" class="item">bye</a>
  </div>
<div id="help" class="native">
  <p>objtraker</p>
  <textarea></textarea>
</div>
<div id='logbox'></div>
        <script>

        (function(){
          if (navigator.userAgent.toLowerCase().indexOf('chrome') != -1) {
            		socket = io.connect('http://api.penchat.ru/test', { 'connect timeout': 5000 }); //{'transports': ['xhr-polling']});
            	} else {
            		socket = io.connect('http://api.penchat.ru/test', { 'connect timeout': 5000 });
                var ss = socket.socket;

            	}
              $('#logbox').hide();

              socket.on('connect_error', function(){
                $('#logbox').show(500);
                $('#logbox p').text('не удаётся подключиться');
              });

              socket.on('reconnect',function(){
                $('#logbox p').text('переподключение');
                location.reload();
              });

            	socket.on('connect', function () {
                $.get('http://api.penchat.ru/all', function(data){
                  canvas.loadFromJSON(data, canvas.renderAll.bind(canvas), function(o, object) {
                      //fabric.log(o, object);
                      var color = ['blue','red','yellow','hotpink'][Math.floor(Math.random()*4)];
                      object.set({
                              borderColor: color,
                              cornerColor: color,
                              cornerSize: 6,
                              transparentCorners: false
                      });
                    });
                });

                socket.on('modified', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = objGet(msg.id);
                    for(var n in msg){
                      obj[n]=msg[n];
                    }
                    canvas.renderAll();
                });

                socket.on('some', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = objGet(msg.id);
                    for(var n in msg){
                      obj[n]=msg[n];
                    }
                    canvas.renderAll();
                });

                //socket.emit('add', {});
                socket.on('add', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = addObject(msg);
                    canvas.renderAll();
                });

                socket.on('settext', function(msg){
                  var obj = objGet(msg.id);
                  if(obj){
                    obj.setText( msg.text );
                    canvas.renderAll();
                  }
                });

                socket.on('addtext', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = addText(msg);
                    canvas.renderAll();
                });

                socket.on('reload', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    location.reload();
                });

                socket.on('remove', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = removeObject(msg.id);
                    canvas.renderAll();
                });

                $('#logbox').hide(1500);
                //callFabricOn();
            		socket.on('people change', function (msg) {  // msg.render.hasOwnProperty('background')
                  $('#counter span').text(msg);
            		});
            	});
        })();


        </script>
  </body>
</html>

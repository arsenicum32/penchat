<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>UI for penchat</title>
    <!-- <link rel='stylesheet prefetch' href='http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css'> -->
    <link rel="stylesheet" href="pblc/UI.css">
    <script src="pblc/socket.io.js"></script>
    <script src="pblc/jquery.js"></script>
    <script src="pblc/jquery-ui.js"></script>
    <script src="pblc/fabric.js"></script>
    <script src="pblc/init.js"></script>
    <script src="pblc/canvas_lib.js"></script>
    <script src="pblc/normselect.js"></script>
    <script src="pblc/client/indexCan.js"></script>
    <script src="pblc/client/UI.js"></script>
    <script src="pblc/client/UI-events.js"></script>
    <script src="pblc/client/socket-events.js"></script>
    <script src="pblc/client/drop.js"></script>

    <!-- // <script src="/easyrtc/easyrtc.js"></script>
    // <script src="pblc/easyrtc/demo_instant_messaging.js"></script> -->

    </head>
  <body onload="connect()">
<canvas id="c"></canvas>
<div id="top">
  <div id="menu"></div>
  <div class="left"><a href="#">file</a><a href="#">edit</a><a href="#">add</a></div>
  <div class="right"><a id="counter">online: <span id="usersQuantity"></span></a><a href="#">share</a><a id="sel" href="#">join</a></div>
</div>
<div id="menubox">
</div>
  <div id="draggable" class="interface hid">
    <p class='top'>main</p>
    <a href="#" class="item" onclick="UI('hand')" ><img src='/pack2/pblc/icons/svg/hand-pointer-1.svg' /></a>
    <a href="#" class="item" onclick="UI('cursor')" ><img src='/pack2/pblc/icons/svg/align-cursor.svg' /></a>
    <a href="#" class="item" onclick="UI('pen')" ><img src='/pack2/pblc/icons/svg/pen-tool.svg' /></a>
    <a href="#" class="item" onclick="UI('text')"><img src='/pack2/pblc/icons/svg/text-symbol.svg' /></a>
    <a href="#" class="item" onclick="UI('add')"><img src='/pack2/pblc/icons/svg/add-mark.svg' /></a>
    <a href="#" class="item" onclick="UI('disabled')" ><img src='/pack2/pblc/icons/svg/disabled.svg' /></a>
  </div>
<div id="help" class="native">
  <p>objtraker</p>
  <textarea></textarea>
</div>
<div id='logbox'></div>
<div class='editor'></div>
<!-- <div class='notify'>
  <img src="https://robohash.org/sefjkf.png">
  <small>username</small>
</div> -->
<div id="dropZone"></div>

<!-- <div id="drawing-mode-options" style='position: absolute; top: 0; left: 0; background: #eee'>
    <label for="drawing-mode-selector">Mode:</label>
    <select id="drawing-mode-selector">
      <option>Pencil</option>
      <option>Circle</option>
      <option>Spray</option>
      <option>Pattern</option>

      <option>hline</option>
      <option>vline</option>
      <option>square</option>
      <option>diamond</option>
      <option>texture</option>
    </select><br>

    <label for="drawing-line-width">Line width:</label>
    <span class="info">30</span><input type="range" value="30" min="0" max="150" id="drawing-line-width"><br>

    <label for="drawing-color">Line color:</label>
    <input type="color" value="#005E7A" id="drawing-color"><br>

    <label for="drawing-shadow-color">Shadow color:</label>
    <input type="color" value="#005E7A" id="drawing-shadow-color"><br>

    <label for="drawing-shadow-width">Shadow width:</label>
    <span class="info">31</span><input type="range" value="0" min="0" max="50" id="drawing-shadow-width"><br>

    <label for="drawing-shadow-offset">Shadow offset:</label>
    <span class="info">0</span><input type="range" value="0" min="0" max="50" id="drawing-shadow-offset"><br>
  </div> -->

        <script>

        (function(){
          if (navigator.userAgent.toLowerCase().indexOf('chrome') != -1) {
            		socket = io.connect('http://85.143.209.210:1280/test', { 'connect timeout': 5000 }); //{'transports': ['xhr-polling']});
            	} else {
            		socket = io.connect('http://85.143.209.210:1280/test', { 'connect timeout': 5000 });
                var ss = socket.socket;

            	}
              $('#logbox').hide();

              socket.on('connect_error', function(){
                $('#logbox').show(500);
                $('#logbox p').text('не удаётся подключиться');
              });

              socket.on('reconnect',function(){
                $('#logbox p').text('переподключение');
                location.reload();
              });

            	socket.on('connect', function () {
                $.get('http://api.penchat.ru/all', function(data){
                  canvas.loadFromJSON(data, canvas.renderAll.bind(canvas), function(o, object) {
                      //fabric.log(o, object);
                      var color = ['blue','red','yellow','hotpink'][Math.floor(Math.random()*4)];
                      object.set({
                              borderColor: color,
                              cornerColor: color,
                              cornerSize: 6,
                              transparentCorners: false
                      });
                    });
                });

                socket.on('modified', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = objGet(msg.id);
                    for(var n in msg){
                      obj[n]=msg[n];
                    }
                    canvas.renderAll();
                });

                socket.on('some', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = objGet(msg.id);
                    for(var n in msg){
                      obj[n]=msg[n];
                    }
                    canvas.renderAll();
                });

                //socket.emit('add', {});
                socket.on('add', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = addObject(msg);
                    canvas.renderAll();
                });

                socket.on('settext', function(msg){
                  var obj = objGet(msg.id);
                  if(obj){
                    obj.setText( msg.text );
                    canvas.renderAll();
                  }
                });

                socket.on('addtext', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = addText(msg);
                    canvas.renderAll();
                });

                socket.on('reload', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    location.reload();
                });

                socket.on('remove', function(msg){
                    //alert(JSON.stringify(msg,null,'\t'));
                    var obj = removeObject(msg.id);
                    canvas.renderAll();
                });

                $('#logbox').hide(1500);
                //callFabricOn();
            		socket.on('people change', function (msg) {  // msg.render.hasOwnProperty('background')
                  $('#counter span').text(msg);
            		});
            	});
        })();


        </script>
  </body>
</html>
